# Writing your first CWL Workflow document

## Goal

Building on the `CommandLineTool` created on the previous step, the first `Workflow` will include two processing steps:

- a fan-out processing pattern to use `gdal_translate` to clip the bands B04, B03 and B02
- a fan-in processing pattern using OTB's image stacking CLI to create an RGB composite 

At this stage, there's a `translate.cwl` CWL document and a file `params.yml`.

## CWL Workflow skeleton

Start creating the CWL workflow document with it's initial structure:

```yaml
class: 
label:  
doc:  
id: 

requirements:

inputs:
  
outputs:

steps:

  node_:
    
    run: 
        
    in:
      

    out:

cwlVersion: v1.0
```

Set the CWL class to `Workflow`:

```yaml hl_lines="1-1"
class: Workflow
label:  
doc:  
id: 

requirements:

inputs:
  
outputs:

steps:

  node_:
    
    run: 
        
    in:
      

    out:

cwlVersion: v1.0
```

## Workflow information

Set the Workflow information (`label`, `doc`) and `id`:

```yaml hl_lines="2-4"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:

inputs:
  
outputs:

steps:

  node_:
    
    run: 
        
    in:
      

    out:

cwlVersion: v1.0
```

## Workflow requirements

Set the Workflow requirements to support the fan-out pattern. Setting the `ScatterFeatureRequirement` requirement tells the CWL runner to spawn several processes (these may run in parallel).

```yaml hl_lines="7-7"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:
  
outputs:

steps:

  node_:
    
    run: 
        
    in:
      

    out:

cwlVersion: v1.0
```

## Workflow inputs

Define the inputs:
- the list of geotifs
- the area of interest
- the EPSG code used to express the area of interest coordinates

The `geotiffs` are a list of files, this workflow parameter type is now `File[]`:

```yaml hl_lines="11-22"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_:
    
    run: 
        
    in:
      

    out:

cwlVersion: v1.0
```

## Workflow processing step

Update the first processing step to set the sub-workflow `translate.cwl` to be run:

```yaml hl_lines="30-30"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_:
    
    run: translate.cwl
        
    in:

    out:

cwlVersion: v1.0
```

## Workflow input mapping

Now, set the step inputs mapping where:

- `translate.cwl` input `geotiff` is mapped to worklow input `geotiffs`
- `translate.cwl` input `aoi` is mapped to worklow input `aoi`
- `translate.cwl` input `epsg` is mapped to worklow input `epsg`

```yaml hl_lines="34-36"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:

cwlVersion: v1.0
```

## Workflow step output

Set the `node_translate` output, i.e. the `clipped_tif` generated by `translate.cwl`:

```yaml hl_lines="39-39"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_translate:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:
    - clipped_tif

cwlVersion: v1.0
```

## Scatter (fan-out)

Now set the fan-out configuration by setting the `scatter` method and input (the geotiffs):

```yaml hl_lines="41-42"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_translate:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:
    - clipped_tif

    scatter: geotiffs
    scatterMethod: dotproduct

cwlVersion: v1.0
```

## Adding another step 

The next step requires an additional CWL CommandLineTool. It's a file called `concatenate.cwl` and it contains:

```yaml
--8<--
101/concatenate.cwl
--8<--
```

Add the additional step to concatenate the clipped geotiffs.

```yaml hl_lines="44-53"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_translate:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:
    - clipped_tif

    scatter: geotiffs
    scatterMethod: dotproduct

  node_concatenate:

    run: concatenate.cwl

    in: 
      tifs:
        source: node_translate/clipped_tif

    out:
    - composite


cwlVersion: v1.0
```

## Mapping the inputs from the previous step

The inputs come from the previous step using the mapping:

```yaml hl_lines="49-50"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:

steps:

  node_translate:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:
    - clipped_tif

    scatter: geotiffs
    scatterMethod: dotproduct

  node_concatenate:

    run: concatenate.cwl

    in: 
      tifs:
        source: node_translate/clipped_tif

    out:
    - composite


cwlVersion: v1.0
```

The workflow only misses the `Workflow` `output` block, a mapping to the `node_concatenate` outputs:

```yaml hl_lines="25-28"
class: Workflow
label: Sentinel-2 RGB creation
doc:  This workflow creates an RGB composite
id: main

requirements:
- class: ScatterFeatureRequirement

inputs:

  geotiffs:
    doc: list of geotifs
    type: File[]

  aoi: 
    doc: area of interest as a bounding box
    type: string
  
  epsg:
    doc: EPSG code 
    type: string
    default: "EPSG:4326"

outputs:
  rgb:
    outputSource:
    - node_concatenate/composite
    type: File

steps:

  node_translate:
    
    run: translate.cwl
        
    in:
 
      geotiff: geotiffs  
      aoi: aoi
      epsg: epsg

    out:
    - clipped_tif

    scatter: geotiffs
    scatterMethod: dotproduct

  node_concatenate:

    run: concatenate.cwl

    in: 
      tifs:
        source: node_translate/clipped_tif

    out:
    - composite


cwlVersion: v1.0
```
## Test the CWL workflow 

Download the three geotiff with:

```console
curl -o B04.tif https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/H/PA/2021/7/S2B_53HPA_20210723_0_L2A/B04.tif
curl -o B03.tif https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/H/PA/2021/7/S2B_53HPA_20210723_0_L2A/B03.tif
curl -o B02.tif https://sentinel-cogs.s3.us-west-2.amazonaws.com/sentinel-s2-l2a-cogs/53/H/PA/2021/7/S2B_53HPA_20210723_0_L2A/B02.tif
```

Create a file called `composite-params.yml` with:

```yaml
--8<--
101/cwl-101/tutorial-2/composite-params.yml
--8<--
```

Run the workflow with:

```
cwltool --parallel composite.cwl composite-params.yml
```

This creates a file called `composite.tif`.
